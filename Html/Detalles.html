<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="USC Predict es una plataforma de predicción de eventos">
    <meta name="keywords" content="USC, Predict, Eventos, Predicción">
    <meta name="author" content="Mateo Bodenlle y Diego Cristóbal">
    <title>Detalles del Evento</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../Css/styles.css">
    <link rel="stylesheet" href="../Css/index.css">
    <link rel="stylesheet" href="../Css/layoutComun.css">
    <link rel="stylesheet" href="../Css/Detalles.css">
</head>
<body>
<!-- Encabezado principal del sitio -->
<header id="navbar"></header>

<!-- Contenido principal -->
<main class="page-container">
    <section class="main-content">
        <div class="evento-header">
            <img class="Imagen" src="" alt="Imagen del evento">
            <article class="exam-details">
                <div class="date">
                    <div class="property">Resolution: </div>
                    <div class="value" id="fechaResolucion">--/--/----</div>
                </div>
                <div class="views">
                    <div class="property">Views: </div>
                    <div class="value" id="nViews">0</div>
                </div>
            </article>
        </div>

        <p class="exam-description" id="descripcionEvento">
            Este evento resolverá si la nota del examen alcanza una nota media estrictamente mayor que 6. Se considera media sin tener en cuenta a los "no presentado", y tras el período de reclamación.
        </p>

        <!-- Contenedor de la gráfica -->
        <div class="chart-container">
            <div class="chart-header">
                <!-- El título se actualizará con el precio actual en formato porcentaje -->
                <h3 class="chart-title" id="chartTitle">--% chance</h3>
                <span class="chart-subtitle">v-0.5</span>
            </div>
            <!-- Canvas para Chart.js -->
            <canvas id="myChart" width="400" height="200"></canvas>
        </div>

        <!-- Se carga Chart.js desde CDN -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </section>

    <aside class="voting-sidebar">
        <!-- Título del evento en la tarjeta de votación -->
        <h1 class="Titulo_Evento" id="tituloEvento">Evento</h1>

        <section class="contenedor-apuesta">
            <article class="header-Apuesta">
                <h2>Votar</h2>
                <button class="market-limit" id="marketLimitBtn">Market</button>
            </article>
            <article class="vote-input">
                <label for="vote-count">Número de votos</label>
                <input type="text" id="vote-count" name="vote-count">
                <div class="botones-aumento">
                    <div class="botones-aumento-lado">
                        <button class="disminucion" id="boton-100">-100</button>
                        <button class="disminucion" id="boton-10">-10</button>
                    </div>
                    <div class="botones-aumento-lado">
                        <button class="aumento" id="boton+10">+10</button>
                        <button class="aumento" id="boton+100">+100</button>
                    </div>
                </div>
            </article>
            <article class="precio">
                <label for="precio-input">Precio</label>
                <div class="selectorPrecio">
                    <button class="disminuir-precio">-</button>
                    <input class="precio-input" name="precio-input" id="precio-input" type="number" value="0.00">
                    <button class="aumentar-precio">+</button>
                </div>
            </article>
            <article class="botones-votar">
                <button class="boton-si">Si</button>
                <button class="boton-no">No</button>
            </article>
            <article class="reporte">
                <div class="reporte-fila">
                    <div class="info-propiedad">TOTAL: </div>
                    <div class="info-valor">0 voting points</div>
                </div>
                <div class="reporte-fila">
                    <div class="info-propiedad">POSIBLE WIN: </div>
                    <div class="info-valor" id="WIN">0 voting points</div>
                </div>
            </article>
            <button class="vote-button">VOTAR</button>
        </section>
    </aside>
</main>

<!-- Pie de página -->
<footer id="footer"></footer>

<!-- Script para cargar los datos del evento desde el JSON y actualizar la página -->
<script>
    // Función para extraer parámetros de la URL
    function getParameterByName(name) {
        const url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    const eventoId = getParameterByName('id');

    if (eventoId) {
        // Ajusta la ruta al JSON según la estructura de tus carpetas
        fetch('../Resources/Data/eventos.json')
            .then(response => response.json())
            .then(eventos => {
                const evento = eventos.find(e => e.id == eventoId);
                if (evento) {
                    // Actualizar encabezado y detalles básicos
                    document.querySelector(".evento-header img.Imagen").src = evento.img;
                    document.querySelector(".exam-details .date .value").textContent = evento.fechaResolucion;
                    document.querySelector(".exam-details .views .value").textContent = evento.nViews;
                    document.getElementById("tituloEvento").textContent = evento.nombre;
                    // Opcional: actualizar la descripción si el JSON tuviera ese campo
                    // document.getElementById("descripcionEvento").textContent = evento.descripcion || "";

                    // Usar el histórico de precios para la gráfica y para la tarjeta de apuesta
                    const historico = evento.historicoPrecios;
                    const precioActual = historico[historico.length - 1];
                    // Actualizar el input de precio en la tarjeta de apuesta
                    document.getElementById("precio-input").value = precioActual.toFixed(2);
                    // Actualizar el título de la gráfica (formateado como porcentaje)
                    document.getElementById("chartTitle").textContent = (precioActual * 100).toFixed(0) + "% chance";

                    // Inicializar la gráfica con los datos del histórico
                    // Generar etiquetas dinámicamente: "T1", "T2", ..., "Tn"
                    const labels = historico.map((_, i) => "T" + (i + 1));
                    const data = {
                        labels: labels,
                        datasets: [{
                            label: 'Chance over time',
                            data: historico,
                            borderColor: '#56b6c2',
                            backgroundColor: '#56b6c2',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        }]
                    };
                    const config = {
                        type: 'line',
                        data: data,
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    ticks: {
                                        callback: function(value) {
                                            return (value * 100) + '%';
                                        }
                                    },
                                    min: 0,
                                    max: 1
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let val = context.parsed.y * 100;
                                            return val.toFixed(1) + '%';
                                        }
                                    }
                                }
                            }
                        }
                    };
                    const ctx = document.getElementById('myChart').getContext('2d');
                    new Chart(ctx, config);
                } else {
                    document.getElementById('detalles-evento').innerHTML = '<p>Evento no encontrado.</p>';
                }
            })
            .catch(error => {
                console.error('Error al cargar el JSON:', error);
                document.getElementById('detalles-evento').innerHTML = '<p>Error al cargar el evento.</p>';
            });
    } else {
        document.getElementById('detalles-evento').innerHTML = '<p>No se especificó ningún evento.</p>';
    }
</script>

<!-- Scripts de votación y ajustes de la tarjeta de apuesta -->
<script src="../Js/componentes.js"></script>
<script src="../Js/trendingListsIndex.js"></script>
<script>
    // Código para la tarjeta de apuesta (Market/Limit, votos, precio, etc.)
    let precio = 0.49; // Valor por defecto; se actualizará al cargar el evento
    const precioMercado = precio.toFixed(2);
    const marketLimitBtn = document.querySelector("#marketLimitBtn");
    const precioSection = document.querySelector(".precio");
    const contenedorApuesta = document.querySelector(".contenedor-apuesta");

    // Modo Market/Limit: true = Market, false = Limit
    let isMarketMode = true;
    precioSection.style.display = "none"; // Comenzamos en modo Market

    function actualizarDatosApuesta() {
        let total = parseInt(inputVoto.value) * parseFloat(inputPrecio.value);
        document.querySelector(".info-valor").textContent = total.toFixed(2) + " voting points";
        let win = parseInt(inputVoto.value);
        document.querySelector("#WIN").textContent = win.toFixed(2) + " voting points";
    }

    marketLimitBtn.addEventListener("click", () => {
        isMarketMode = !isMarketMode;
        if (isMarketMode) {
            marketLimitBtn.textContent = "Market";
            precio = precioMercado;
            precioSection.querySelector("input").value = precio;
            actualizarDatosApuesta();
            precioSection.style.display = "none";
            contenedorApuesta.style.height = "436px";
        } else {
            contenedorApuesta.style.height = "540px";
            setTimeout(() => {
                precioSection.style.display = "block";
            }, 60);
            marketLimitBtn.textContent = "Limit";
        }
    });

    let modo = "start";
    let botonSi = document.querySelector(".boton-si");
    let botonNo = document.querySelector(".boton-no");
    let botonVotar = document.querySelector(".vote-button");
    let precioInput = document.querySelector(".precio-input");
    precioInput.value = precio;
    botonVotar.disabled = true;

    botonSi.addEventListener("click", function() {
        modo = "si";
        botonSi.classList.add("active");
        botonNo.classList.remove("active");
        precioInput.value = precio;
        botonVotar.disabled = false;
        botonVotar.classList.add("si");
        botonVotar.classList.remove("no");
    });

    botonNo.addEventListener("click", function() {
        modo = "no";
        botonNo.classList.add("active");
        botonSi.classList.remove("active");
        precioInput.value = 1 - precio;
        botonVotar.disabled = false;
        botonVotar.classList.add("no");
        botonVotar.classList.remove("si");
    });

    botonVotar.addEventListener("click", function() {
        if (modo === "si") {
            alert("Has votado 'Sí' con un precio de " + precioInput.value);
        } else if (modo === "no") {
            alert("Has votado 'No' con un precio de " + precioInput.value);
        } else {
            alert("Por favor, selecciona una opción antes de votar.");
        }
    });

    const botonMas10 = document.querySelector("#boton\\+10");
    const botonMas100 = document.querySelector("#boton\\+100");
    const botonMenos10 = document.querySelector("#boton-10");
    const botonMenos100 = document.querySelector("#boton-100");
    const botonAumentarPrecio = document.querySelector(".aumentar-precio");
    const botonDisminuirPrecio = document.querySelector(".disminuir-precio");
    const inputVoto = document.querySelector("#vote-count");
    const inputPrecio = document.querySelector("#precio-input");

    botonMas10.addEventListener("click", function() {
        if (inputVoto.value === "") { inputVoto.value = 0; }
        inputVoto.value = parseInt(inputVoto.value) + 10;
    });
    botonMas100.addEventListener("click", function() {
        if (inputVoto.value === "") { inputVoto.value = 0; }
        inputVoto.value = parseInt(inputVoto.value) + 100;
    });
    botonMenos10.addEventListener("click", function() {
        if (inputVoto.value === "") { inputVoto.value = 0; }
        inputVoto.value = parseInt(inputVoto.value) - 10;
        if (inputVoto.value < 0) { inputVoto.value = 0; }
    });
    botonMenos100.addEventListener("click", function() {
        if (inputVoto.value === "") { inputVoto.value = 0; }
        inputVoto.value = parseInt(inputVoto.value) - 100;
        if (inputVoto.value < 0) { inputVoto.value = 0; }
    });
    botonAumentarPrecio.addEventListener("click", function() {
        inputPrecio.value = (parseFloat(inputPrecio.value) + 0.01).toFixed(2);
    });
    botonDisminuirPrecio.addEventListener("click", function() {
        inputPrecio.value = (parseFloat(inputPrecio.value) - 0.01).toFixed(2);
    });

    inputPrecio.addEventListener("input", actualizarDatosApuesta);
    inputVoto.addEventListener("input", actualizarDatosApuesta);
    botonMas10.addEventListener("click", actualizarDatosApuesta);
    botonMas100.addEventListener("click", actualizarDatosApuesta);
    botonMenos10.addEventListener("click", actualizarDatosApuesta);
    botonMenos100.addEventListener("click", actualizarDatosApuesta);
    botonAumentarPrecio.addEventListener("click", actualizarDatosApuesta);
    botonDisminuirPrecio.addEventListener("click", actualizarDatosApuesta);

    inputVoto.addEventListener("change", function() {
        if (isNaN(parseInt(inputVoto.value))) {
            document.querySelector(".info-valor").textContent = "0 voting points";
            document.querySelector("#WIN").textContent = "0 voting points";
        }
    });
    inputPrecio.addEventListener("change", function() {
        if (isNaN(parseFloat(inputPrecio.value))) {
            document.querySelector(".info-valor").textContent = "0 voting points";
            document.querySelector("#WIN").textContent = "0 voting points";
        }
    });
</script>
<script src="../Js/trendingListsIndex.js"></script>
</body>
</html>
