<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Watchlist: listado de apuestas pendientes, con datos del evento">
    <meta name="keywords" content="USC, Predict, Eventos, Apuestas, Watchlist">
    <meta name="author" content="Mateo Bodenlle y Diego Cristóbal">
    <title>Watchlist</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../Css/styles.css">
    <link rel="stylesheet" href="../Css/watchlist.css">
    <link rel="stylesheet" href="../Css/layoutComun.css">
    <link rel="stylesheet" href="../Css/Componentes/categories.css">
    <link rel="stylesheet" href="../Css/Componentes/bettedCard.css">
    <link rel="stylesheet" href="../Css/Componentes/historyCards.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<!-- Encabezado principal -->
<header id="navbar"></header>
<!-- Contenido principal -->
<main class="container">
    <h1>Watchlist</h1>
    <!-- Contenedor para las tarjetas de apuestas pendientes -->
    <section id="tarjetas-resultado"></section>

    <h1>Historial</h1>
    <div class="historial-container">
        <div class="historial-grid">
            <!-- Columna Ganadas -->
            <div class="historial-columna">
                <h2>Ganadas</h2>
                <div class="scroll-wrapper">
                    <div id="tarjetas-ganadas" class="scroll-vertical"></div>
                </div>
            </div>
            <!-- Medidor central -->
            <div class="outer">
                <div class="gauge-wrapper">
                    <h2>Ratio de aciertos</h2>
                    <div id="container-speed" class="chart-container"></div>
                    <div id="container-ratio"></div>
                    <div class="gauge-needle" id="needle"></div>
                </div>
            </div>
            <!-- Columna Perdidas -->
            <div class="historial-columna">
                <h2>Perdidas</h2>
                <div class="scroll-wrapper">
                    <div id="tarjetas-perdidas" class="scroll-vertical"></div>
                </div>
            </div>
        </div>
    </div>
</main>
<!-- Pie de página -->
<footer id="footer"></footer>
</body>
</html>

<!-- Script para cargar apuestas (Watchlist) -->
<script type="module">
    // Importamos la función para crear tarjetas de apuesta
    import { createBettedCard } from '../Js/loaderBettedCards.js';

    $(document).ready(function() {
        // Primero, cargamos el JSON de eventos
        $.getJSON('../Resources/Data/eventos.json')
            .done(function(eventosData) {
                // Luego, cargamos el XML de apuestas
                $.ajax({
                    url: '../Resources/Data/apuestas.xml',
                    dataType: 'xml',
                    success: function(xml) {
                        // Vaciar el contenedor de Watchlist
                        $("#tarjetas-resultado").empty();
                        // Recorrer cada <apuesta> del XML
                        $(xml).find("apuesta").each(function() {
                            var $apuesta = $(this);
                            var eventoId = $apuesta.find("eventoId").text().trim();
                            var evento = eventosData.find(function(e) { return e.id == eventoId; });


                            var precioCompra = $apuesta.find("precioCompra").text().trim();
                            var precioActual = $apuesta.find("precioActual").text().trim();
                            var numeroVotos = $apuesta.find("numeroVotos").text().trim();
                            // Podemos leer también apuesta y apuestaId si fuese necesario, pero no se muestran en la tarjeta

                            // Buscar en el JSON el evento correspondiente
                            if (evento) {
                                var fechaResolucion = new Date(evento.fechaResolucion);
                                var ahora = new Date();
                                if (fechaResolucion <= ahora || evento.resultado === "SI" || evento.resultado === "NO") {
                                    return; // Se salta esta apuesta
                                }
                                // Creamos un objeto combinando la info del evento y de la apuesta.
                                // Se reutilizan solo los atributos que ya se muestran en la tarjeta de apuesta.
                                var betData = {
                                    id: evento.id,
                                    img: evento.img,
                                    nombre: evento.nombre,
                                    categoria: evento.categoria,
                                    porcentaje: evento.porcentaje || "" // Puedes ajustar este campo según tu lógica
                                };
                                // Crear la tarjeta de apuesta usando la función importada
                                var card = createBettedCard(betData, function(bet) {
                                    // Al hacer clic en la tarjeta, redirigimos a Detalles sin parámetros de voto.
                                    window.location.href = `Detalles.html?id=${bet.id}`;
                                });
                                // Añadir la tarjeta al contenedor de Watchlist
                                $("#tarjetas-resultado").append(card);
                            }
                        });
                    },
                    error: function() {
                        $("#tarjetas-resultado").html("<p>Error al cargar las apuestas.</p>");
                    }
                });
            })
            .fail(function() {
                $("#tarjetas-resultado").html("<p>Error al cargar los datos de eventos.</p>");
            });
    });
</script>

<!-- Scripts generales -->
<script src="../Js/componentes.js"></script>

<!-- Scripts para Historial y Gráfica (se mantienen igual) -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
<script src="../Js/graficoVelocimetro.js"></script>
<script type="module">
    // Gráfica del Historial
    function actualizarAguja(valor) {
        const angulo = (valor / 100) * 180 - 90;
        $("#needle").css("transform", `translateX(-50%) rotate(${angulo}deg)`);
    }
    function actualizarGrafica(valor) {
        actualizarAguja(valor);
        actualizarRatio(valor);
    }
    setTimeout(() => {
        actualizarGrafica(67);
    }, 1000);

    import { verticalScroll } from "../Js/verticalScroll.js";
    const scrollContenedores = $(".scroll-vertical").get();
    verticalScroll(scrollContenedores);



    import { generateBettedCards } from '../Js/loaderBettedCards.js';
    import { tarjetas, cargarDetalles, manejarSi, manejarNo } from '../Js/exampleData/cards.js';
    const cardsWinned = $("#tarjetas-ganadas");
    const cardsLost = $("#tarjetas-perdidas");
    generateBettedCards(cardsWinned, tarjetas, cargarDetalles, manejarSi, manejarNo);
    generateBettedCards(cardsLost, tarjetas, cargarDetalles, manejarSi, manejarNo);
</script>
